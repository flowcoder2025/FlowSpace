# FlowSpace ì•„í‚¤í…ì²˜

> **í”„ë¡œì íŠ¸**: ZEP-ê°ì„± 2D ë©”íƒ€ë²„ìŠ¤ MVP
> **ê¸°ìˆ  ìŠ¤íƒ**: Phaser 3 + Socket.io + LiveKit + Next.js 15

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FlowSpace Platform                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Next.js    â”‚  â”‚  Socket.io   â”‚  â”‚   LiveKit    â”‚          â”‚
â”‚  â”‚   (3000)     â”‚  â”‚   (3001)     â”‚  â”‚   (7880)     â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚  â€¢ ì¸ì¦/ê¶Œí•œ  â”‚  â”‚  â€¢ ìœ„ì¹˜ë™ê¸°í™” â”‚  â”‚  â€¢ ìŒì„±/ì˜ìƒ  â”‚          â”‚
â”‚  â”‚  â€¢ API ë¼ìš°íŠ¸ â”‚  â”‚  â€¢ ì±„íŒ…      â”‚  â”‚  â€¢ í™”ë©´ê³µìœ    â”‚          â”‚
â”‚  â”‚  â€¢ ëŒ€ì‹œë³´ë“œ   â”‚  â”‚  â€¢ ì„¸ì…˜ê²€ì¦  â”‚  â”‚  â€¢ WebRTC    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Phaser 3 Game Engine                   â”‚   â”‚
â”‚  â”‚   â€¢ 2D ë§µ ë Œë”ë§ â€¢ ìºë¦­í„° ì´ë™ â€¢ ìƒí˜¸ì‘ìš© ì˜¤ë¸Œì íŠ¸        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Supabase PostgreSQL + Prisma                 â”‚   â”‚
â”‚  â”‚   â€¢ User â€¢ Space â€¢ Template â€¢ GuestSession â€¢ EventLog    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ê¸°ìˆ  ìŠ¤íƒ

### 2.1 Frontend Layer

| ê¸°ìˆ  | ë²„ì „ | ì—­í•  |
|-----|------|------|
| Next.js | 15 | App Router, RSC |
| React | 19 | UI ì»´í¬ë„ŒíŠ¸ |
| TypeScript | 5.x | íƒ€ì… ì•ˆì „ì„± |
| Tailwind CSS | 4 | ìŠ¤íƒ€ì¼ë§ |
| shadcn/ui | latest | UI ì»´í¬ë„ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ |

### 2.2 Game Layer

| ê¸°ìˆ  | ì—­í•  |
|-----|------|
| Phaser 3 | 2D ê²Œì„ ì—”ì§„, ë§µ/ìºë¦­í„° ë Œë”ë§ |
| react-resizable-panels | ZEP ìŠ¤íƒ€ì¼ ë¦¬ì‚¬ì´ì¦ˆ íŒ¨ë„ |
| @dnd-kit/core | ë“œë˜ê·¸ ê°€ëŠ¥ ë¹„ë””ì˜¤ |

### 2.3 Real-time Layer

| ê¸°ìˆ  | í¬íŠ¸ | ì—­í•  |
|-----|------|------|
| Socket.io | 3001 | ìœ„ì¹˜/ì±„íŒ… ë™ê¸°í™” |
| LiveKit | 7880 | WebRTC ìŒì„±/ì˜ìƒ |

### 2.4 Backend Layer

| ê¸°ìˆ  | ì—­í•  |
|-----|------|
| Prisma | ORM, ìŠ¤í‚¤ë§ˆ ê´€ë¦¬ |
| Supabase | PostgreSQL í˜¸ìŠ¤íŒ… |
| NextAuth.js | ì¸ì¦ (OAuth) |

---

## 3. í•µì‹¬ ë°ì´í„° ëª¨ë¸

```
User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€ Space â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Template
              â”‚         â”‚
              â”‚         â”œâ”€â”€ SpaceBranding
              â”‚         â”œâ”€â”€ SpaceAccessPolicy
              â”‚         â””â”€â”€ SpaceEventLog
              â”‚
              â””â”€â”€â”€â”€â”€ GuestSession
```

### ì£¼ìš” ì—”í‹°í‹°

| ì—”í‹°í‹° | ì—­í•  |
|-------|------|
| User | ì¸ì¦ëœ ì‚¬ìš©ì (OAuth) |
| Space | ë©”íƒ€ë²„ìŠ¤ ê³µê°„ (ì›”ë“œ) |
| Template | ë§µ í…œí”Œë¦¿ (ì˜¤í”¼ìŠ¤, ê°•ì˜ì‹¤, ë¼ìš´ì§€) |
| GuestSession | ê²ŒìŠ¤íŠ¸ ì„¸ì…˜ (ì„ì‹œ ì‚¬ìš©ì) |
| SpaceEventLog | ì´ë²¤íŠ¸ ë¡œê·¸ (ì…ì¥, í‡´ì¥, ìƒí˜¸ì‘ìš©) |

---

## 4. ë³´ì•ˆ ì•„í‚¤í…ì²˜

### 4.1 ì„œë²„ íŒŒìƒ ID íŒ¨í„´

```
í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ (playerId, sessionToken)
            â†“
    ì„œë²„ ì„¸ì…˜ ê²€ì¦ (/api/guest/verify)
            â†“
    ì„œë²„ íŒŒìƒ ID ë°˜í™˜ (effectivePlayerId)
            â†“
    ì´í›„ ëª¨ë“  ì´ë²¤íŠ¸ì—ì„œ ì„œë²„ ID ê°•ì œ ì‚¬ìš©
```

### 4.2 ID íë¦„

| ë ˆì´ì–´ | ID ì¢…ë¥˜ | ì†ŒìŠ¤ |
|-------|--------|------|
| Socket.io | playerId | ì„œë²„ ê²€ì¦ (`socket.data.playerId`) |
| LiveKit | participantId | API í† í° ë°œê¸‰ ì‹œ ì„œë²„ì—ì„œ ê²°ì • |
| í”„ë¡ íŠ¸ì—”ë“œ | effectivePlayerId | ì„œë²„ì—ì„œ ë°›ì€ ID ì‚¬ìš© |

---

## 5. ì»´í¬ë„ŒíŠ¸ ì•„í‚¤í…ì²˜

### 5.1 Space ì§„ì… íë¦„

```
/space/[id]/page.tsx
        â†“
    SpaceLayout
        â”œâ”€â”€ LiveKitRoomProvider (í† í° í˜ì¹­ + ì»¨í…ìŠ¤íŠ¸)
        â””â”€â”€ SpaceLayoutContent
                â”œâ”€â”€ useSocket() (ìœ„ì¹˜/ì±„íŒ…)
                â”œâ”€â”€ useLiveKitMedia() (ìŒì„±/ì˜ìƒ)
                â”‚
                â”œâ”€â”€ SpaceHeader
                â”œâ”€â”€ PanelGroup
                â”‚   â”œâ”€â”€ GameCanvas (ì¤‘ì•™)
                â”‚   â””â”€â”€ ParticipantPanel (ìš°ì¸¡, ë¦¬ì‚¬ì´ì¦ˆ)
                â”œâ”€â”€ FloatingChatOverlay (ê²Œì„ ìœ„ ì˜¤ë²„ë ˆì´)
                â”œâ”€â”€ ControlBar (í•˜ë‹¨)
                â””â”€â”€ ScreenShareOverlay (ì¡°ê±´ë¶€)
```

### 5.2 ì±„íŒ… ì‹œìŠ¤í…œ (Floating Overlay)

```
FloatingChatOverlay
    â”œâ”€â”€ useChatMode() (ACTIVE/INACTIVE í† ê¸€)
    â”œâ”€â”€ useChatDrag() (ë“œë˜ê·¸ ìœ„ì¹˜, localStorage ì €ì¥)
    â”œâ”€â”€ useChatStorage() (ë©”ì‹œì§€ ì˜ì†ì„±)
    â”‚
    â”œâ”€â”€ ChatTabs (ì „ì²´/ê·“ì†ë§/íŒŒí‹°)
    â”œâ”€â”€ ChatMessageList (ìŠ¤í¬ë¡¤, ìë™ìŠ¤í¬ë¡¤)
    â””â”€â”€ ChatInputArea (Enter ì „ì†¡, ESC ì·¨ì†Œ)
```

**ì±„íŒ… íƒ€ì…**:
| íƒ€ì… | ì„¤ëª… |
|-----|------|
| message | ì „ì²´ ê³µê°œ ì±„íŒ… |
| whisper | 1:1 ê·“ì†ë§ |
| party | íŒŒí‹°ì› ì „ìš© |
| system | ì‹œìŠ¤í…œ ì•Œë¦¼ |
| announcement | ê³µì§€ì‚¬í•­ |

### 5.3 Phaser-React í†µí•©

```
PhaserGame.tsx
    â”œâ”€â”€ Phaser.Game ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
    â”œâ”€â”€ useEffect í´ë¦°ì—… (game.destroy)
    â””â”€â”€ eventBridge
            â”œâ”€â”€ React â†’ Phaser: PLAYER_MOVE, SET_PLAYERS, CHAT_FOCUS_CHANGED
            â””â”€â”€ Phaser â†’ React: PLAYER_MOVED, OBJECT_INTERACT
```

### 5.4 ë¹„ë””ì˜¤ íƒ€ì¼ (VideoTile)

```
VideoTile
    â”œâ”€â”€ LiveKit Track ë Œë”ë§
    â”œâ”€â”€ CSS hue-rotate ì•„ë°”íƒ€ ìƒ‰ìƒ ë³€í™˜
    â”œâ”€â”€ ë§ˆì´í¬/ì¹´ë©”ë¼ ìƒíƒœ í‘œì‹œ
    â””â”€â”€ ì°¸ê°€ì ë‹‰ë„¤ì„ ì˜¤ë²„ë ˆì´
```

**ì•„ë°”íƒ€ ìƒ‰ìƒ ì‹œìŠ¤í…œ**:
- `AvatarColor`: default | red | green | purple | orange | pink
- CSS `filter: hue-rotate(Xdeg)` ë¡œ ìƒ‰ìƒ ë³€í™˜

---

## 6. API ë¼ìš°íŠ¸

### 6.1 ì¸ì¦/ì„¸ì…˜

| ë¼ìš°íŠ¸ | ë©”ì„œë“œ | ì—­í•  |
|-------|-------|------|
| `/api/auth/[...nextauth]` | * | NextAuth í•¸ë“¤ëŸ¬ |
| `/api/guest` | POST | ê²ŒìŠ¤íŠ¸ ì„¸ì…˜ ìƒì„± |
| `/api/guest/verify` | POST | ì„¸ì…˜ ê²€ì¦ |
| `/api/guest/exit` | POST | ì„¸ì…˜ ì¢…ë£Œ |

### 6.2 ê³µê°„ ê´€ë¦¬

| ë¼ìš°íŠ¸ | ë©”ì„œë“œ | ì—­í•  |
|-------|-------|------|
| `/api/spaces` | GET/POST | ê³µê°„ ëª©ë¡/ìƒì„± |
| `/api/spaces/[id]` | GET/PATCH/DELETE | ê³µê°„ ì¡°íšŒ/ìˆ˜ì •/ì‚­ì œ |
| `/api/livekit/token` | POST | LiveKit í† í° ë°œê¸‰ |

### 6.3 ê´€ë¦¬ì

| ë¼ìš°íŠ¸ | ë©”ì„œë“œ | ì—­í•  |
|-------|-------|------|
| `/api/admin/spaces` | GET | ê³µê°„ í†µê³„ |
| `/api/admin/logs` | GET | ì´ë²¤íŠ¸ ë¡œê·¸ |

---

## 7. ì‹¤ì‹œê°„ ì´ë²¤íŠ¸

### 7.1 Socket.io ì´ë²¤íŠ¸

**í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„**:
| ì´ë²¤íŠ¸ | í˜ì´ë¡œë“œ | ì„¤ëª… |
|-------|---------|------|
| `join:space` | `{ spaceId, playerId, nickname, avatarColor, sessionToken }` | ê³µê°„ ì…ì¥ |
| `leave:space` | - | ê³µê°„ í‡´ì¥ + EXIT ë¡œê·¸ |
| `player:move` | `PlayerPosition` | ìœ„ì¹˜ ì—…ë°ì´íŠ¸ |
| `player:jump` | `PlayerJumpData` | ì í”„ ì´ë²¤íŠ¸ |
| `chat:message` | `{ content }` | ì „ì²´ ì±„íŒ… |
| `whisper:send` | `{ targetId, content }` | ê·“ì†ë§ ì „ì†¡ |
| `party:create` | - | íŒŒí‹° ìƒì„± |
| `party:invite` | `{ targetId }` | íŒŒí‹° ì´ˆëŒ€ |
| `party:accept` | `{ partyId }` | ì´ˆëŒ€ ìˆ˜ë½ |
| `party:decline` | `{ partyId }` | ì´ˆëŒ€ ê±°ì ˆ |
| `party:leave` | - | íŒŒí‹° íƒˆí‡´ |
| `party:message` | `{ content }` | íŒŒí‹° ì±„íŒ… |

**ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸**:
| ì´ë²¤íŠ¸ | í˜ì´ë¡œë“œ | ì„¤ëª… |
|-------|---------|------|
| `room:joined` | `{ spaceId, players, yourPlayerId }` | ì…ì¥ ì™„ë£Œ (ğŸ”’ ì„œë²„ ID) |
| `player:joined` | `PlayerPosition` | ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì…ì¥ |
| `player:left` | `{ id }` | í”Œë ˆì´ì–´ í‡´ì¥ |
| `player:moved` | `PlayerPosition` | ìœ„ì¹˜ ë™ê¸°í™” |
| `player:jumped` | `PlayerJumpData` | ì í”„ ë™ê¸°í™” |
| `chat:message` | `ChatMessageData` | ì±„íŒ… ìˆ˜ì‹  |
| `chat:system` | `ChatMessageData` | ì‹œìŠ¤í…œ ë©”ì‹œì§€ |
| `whisper:received` | `WhisperData` | ê·“ì†ë§ ìˆ˜ì‹  |
| `party:invited` | `PartyInviteData` | ì´ˆëŒ€ ìˆ˜ì‹  |
| `party:updated` | `PartyData` | íŒŒí‹° ìƒíƒœ ë³€ê²½ |
| `party:message` | `ChatMessageData` | íŒŒí‹° ì±„íŒ… |
| `error` | `{ message }` | ì—ëŸ¬ ì•Œë¦¼ |

### 7.2 LiveKit íŠ¸ë™

| íŠ¸ë™ ì¢…ë¥˜ | ìš©ë„ |
|----------|------|
| Camera | ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ |
| Microphone | ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ |
| ScreenShare | í™”ë©´ ê³µìœ  |

---

## 8. ê°œë°œ í™˜ê²½

### 8.1 ë¡œì»¬ ì‹¤í–‰

```bash
npm run dev:all    # Next.js + Socket.io + LiveKit ë™ì‹œ ì‹¤í–‰
```

### 8.2 ì„œë¹„ìŠ¤ í¬íŠ¸

| ì„œë¹„ìŠ¤ | í¬íŠ¸ | URL |
|-------|------|-----|
| Next.js | 3000 | http://localhost:3000 |
| Socket.io | 3001 | ws://localhost:3001 |
| LiveKit | 7880 | ws://localhost:7880 |

### 8.3 í…ŒìŠ¤íŠ¸ URL

```
http://localhost:3000/space/test?dev=true
```

---

## 9. ë¬¸ì„œ ì°¸ì¡°

| ì˜ì—­ | ë¬¸ì„œ ìœ„ì¹˜ |
|-----|----------|
| ì „ì—­ ì›ì¹™ | `/CLAUDE.md` |
| Space ëª¨ë“ˆ | `/src/features/space/claude.md` |
| Socket ì„œë²„ | `/server/claude.md` |
| PRD | `/docs/PRD.md` |

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë³€ê²½ |
|-----|------|
| 2025-12-08 | ì´ˆê¸° ìƒì„± - Phase 1-4 ì™„ë£Œ ìƒíƒœ ë°˜ì˜ |
| 2025-12-11 | ì±„íŒ… ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ (Floating Overlay, ê·“ì†ë§/íŒŒí‹°), VideoTile ì•„ë°”íƒ€ ìƒ‰ìƒ |
