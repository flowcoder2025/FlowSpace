# 공간 기반 커뮤니케이션 시스템 설계

> **최종 업데이트**: 2026-01-09
> **상위 문서**: `/docs/ROADMAP.md`
> **상태**: 📋 설계 완료, 구현 대기

---

## 1. 개요

### 1.1 현재 상태
- 공간 내 **모든 유저**가 전역적으로 오디오/비디오/화면공유 연결
- 위치와 무관하게 전체 참가자가 서로 보고 들을 수 있음

### 1.2 목표 상태
- **근접 기반 통신**: 7×7 타일 영역 내 인접 유저끼리만 연결 (기본값)
- **파티 존**: 맵의 특정 영역에서 그룹 통신
- **스포트라이트**: 특정 위치에서 전체 브로드캐스트 (권한 기반)

---

## 2. 핵심 기능

### 2.1 근접 기반 통신 (Proximity-based Communication)

```
┌─────────────────────────────────────────────────────────────────┐
│                         맵 전체                                  │
│                                                                 │
│     [A]                                                         │
│       ╲                                                         │
│        ╲  거리 > 7타일                                          │
│         ╲  → 연결 해제                                          │
│          ╲                                                      │
│           ╲                                                     │
│     ┌─────────────────┐                                         │
│     │   7×7 영역      │     [B] ←──→ [C]                        │
│     │   (반경 3타일)   │      ↑        ↑                        │
│     │       [A]       │      │        │                        │
│     │        ↕        │      └────────┘                        │
│     │       [D]       │    거리 ≤ 7타일                         │
│     └─────────────────┘    → 연결 유지                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**동작 방식**:
| 항목 | 설명 |
|------|------|
| **범위** | 중심으로부터 반경 3타일 (7×7 그리드) |
| **오디오** | 범위 내 유저끼리만 음성 공유 |
| **비디오** | 범위 내 유저끼리만 영상 공유 |
| **화면공유** | 범위 내 유저끼리만 화면 공유 |
| **거리 감쇠** | (선택) 거리에 따라 볼륨 자동 조절 |

---

### 2.2 파티 존 (Party Zone)

```
┌─────────────────────────────────────────────────────────────────┐
│                         맵 전체                                  │
│                                                                 │
│     ┌───────────────────────┐                                   │
│     │    📍 파티 존 A        │                                   │
│     │    (회의실)            │                                   │
│     │                       │                                   │
│     │   [A] ←──→ [B]        │     [E] (존 외부, 연결 안됨)       │
│     │    ↑        ↑         │                                   │
│     │    │        │         │                                   │
│     │    └────────┘         │                                   │
│     │       ↕               │                                   │
│     │      [C]              │                                   │
│     │                       │                                   │
│     └───────────────────────┘                                   │
│                                                                 │
│     ┌───────────────────────┐                                   │
│     │    📍 파티 존 B        │                                   │
│     │    (강연장)            │                                   │
│     │                       │                                   │
│     │   [D] ←──→ [F]        │                                   │
│     └───────────────────────┘                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**동작 방식**:
| 항목 | 설명 |
|------|------|
| **정의** | 맵에 특정 영역(직사각형 좌표)을 "파티 존"으로 지정 |
| **진입** | 존 영역 내 좌표에 위치하면 자동 가입 |
| **이탈** | 존 영역 외부로 이동하면 자동 탈퇴 |
| **통신** | 같은 존 내 유저끼리만 오디오/비디오/화면공유 |
| **채팅** | 같은 존 내 유저끼리만 "파티 채팅" |
| **근접 무시** | 존 내에서는 7×7 근접 규칙 무시 (존 전체가 하나의 그룹) |

**존 정의 방식**:
```typescript
interface PartyZone {
  id: string
  spaceId: string
  name: string           // "회의실 A", "강연장" 등
  bounds: {
    x1: number          // 좌상단 X
    y1: number          // 좌상단 Y
    x2: number          // 우하단 X
    y2: number          // 우하단 Y
  }
  createdBy: string     // 생성자 (OWNER/STAFF)
}
```

---

### 2.3 스포트라이트 (Spotlight)

```
┌─────────────────────────────────────────────────────────────────┐
│                         맵 전체                                  │
│                                                                 │
│     [청중A]  [청중B]  [청중C]  [청중D]  [청중E]                   │
│         ↑       ↑       ↑       ↑       ↑                      │
│         │       │       │       │       │                      │
│         └───────┴───────┼───────┴───────┘                      │
│                         │                                       │
│                    ┌────┴────┐                                  │
│                    │ 🎤 무대  │ ← 스포트라이트 존                │
│                    │         │                                  │
│                    │  [발표자]│ ← 권한 부여 + 존 내 위치 필수    │
│                    │         │                                  │
│                    └─────────┘                                  │
│                                                                 │
│     ⚠️ 발표자가 무대 밖으로 나가면 스포트라이트 자동 해제        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**동작 방식**:
| 항목 | 설명 |
|------|------|
| **권한 부여** | SuperAdmin, OWNER, STAFF만 타 사용자에게 스포트라이트 권한 부여 가능 |
| **위치 제한** | 스포트라이트 오브젝트(무대/단상)가 설치된 영역에서만 활성화 |
| **브로드캐스트** | 스포트라이트 활성화 시 **전체 공간**에 오디오/비디오/화면공유 |
| **자동 해제** | 스포트라이트 존 밖으로 이동 시 자동 해제 |
| **UI 표시** | 스포트라이트 활성화된 유저는 특별 UI (왕관 아이콘 등) |

**스포트라이트 존 정의**:
```typescript
interface SpotlightZone {
  id: string
  spaceId: string
  objectId: string       // 연결된 MapObject ID (무대/단상 등)
  bounds: {
    x1: number
    y1: number
    x2: number
    y2: number
  }
  maxSpotlights: number  // 동시 활성화 가능 인원 (기본: 1)
}

interface SpotlightGrant {
  id: string
  spaceId: string
  userId: string         // 권한 부여받은 사용자
  grantedBy: string      // 부여한 관리자
  grantedAt: Date
  expiresAt?: Date       // 만료 시간 (선택)
}
```

---

## 3. 통신 우선순위

여러 상태가 겹칠 때의 우선순위:

```
┌─────────────────────────────────────────────────────────────────┐
│                     통신 우선순위 (높음 → 낮음)                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1️⃣ 스포트라이트 (Spotlight)                                    │
│     └── 조건: 권한 보유 + 스포트라이트 존 내 위치                 │
│     └── 범위: 전체 공간                                          │
│                                                                 │
│  2️⃣ 파티 존 (Party Zone)                                        │
│     └── 조건: 파티 존 영역 내 위치                               │
│     └── 범위: 같은 존 내 모든 유저                               │
│                                                                 │
│  3️⃣ 근접 기반 (Proximity)                                       │
│     └── 조건: 기본 상태                                          │
│     └── 범위: 7×7 영역 내 유저                                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 채팅 시스템 연동

| 채팅 타입 | 범위 | 조건 |
|----------|------|------|
| **전체 채팅** | 공간 내 모든 유저 | 언제든 가능 |
| **근접 채팅** | 7×7 영역 내 유저 | 파티 존 외부에서 기본 |
| **파티 채팅** | 같은 존 내 유저 | 파티 존 내 위치 시 |
| **귓속말** | 특정 1명 | 닉네임 지정 |

**기존 채팅 타입과 매핑**:
```typescript
enum MessageType {
  MESSAGE      // 전체 채팅 (기존)
  WHISPER      // 귓속말 (기존)
  PARTY        // 파티 채팅 → 파티 존 채팅으로 재정의
  LOCAL        // 🆕 근접 채팅 (7×7 영역)
  SYSTEM       // 시스템 메시지 (기존)
  ANNOUNCEMENT // 공지 (기존)
}
```

---

## 5. 구현 Phase

### Phase 1: 근접 기반 통신 (Proximity)
**예상 작업량**: 중

- [ ] LiveKit 트랙 구독 동적 관리
  - `useProximitySubscription` 훅 생성
  - 거리 계산 및 구독/해제 로직
- [ ] Socket.io 위치 이벤트 활용
  - `player:move` 이벤트에서 근접 유저 계산
- [ ] 거리 감쇠 (선택)
  - 거리에 따른 볼륨 조절

### Phase 2: 파티 존 시스템 (Party Zone)
**예상 작업량**: 중~대

- [ ] DB 스키마
  - `PartyZone` 테이블 추가
- [ ] 존 CRUD API
  - `/api/spaces/[id]/zones` 엔드포인트
- [ ] 존 진입/이탈 감지
  - Socket.io에서 위치 기반 존 체크
- [ ] 파티 채팅 라우팅
  - 존 내 유저에게만 메시지 전달

### Phase 3: 스포트라이트 시스템 (Spotlight)
**예상 작업량**: 중

- [ ] DB 스키마
  - `SpotlightZone`, `SpotlightGrant` 테이블
- [ ] 권한 부여 API
  - `/api/spaces/[id]/spotlight/grant`
- [ ] 스포트라이트 존 정의
  - 맵 오브젝트와 연결
- [ ] 전체 브로드캐스트 로직
  - LiveKit 트랙 강제 구독
- [ ] UI 표시
  - 스포트라이트 아이콘, 권한 부여 UI

### Phase 4: 채팅 통합
**예상 작업량**: 소

- [ ] `LOCAL` 메시지 타입 추가
- [ ] 근접/존 기반 채팅 라우팅
- [ ] 채팅 UI 범위 표시

---

## 6. 기술 고려사항

### 6.1 LiveKit Track Subscription

```typescript
// 현재: 모든 참가자 트랙 자동 구독
// 변경: 조건부 구독

// useProximitySubscription.ts
function updateSubscriptions(
  localPosition: Position,
  remotePlayers: Map<string, Player>,
  partyZones: PartyZone[],
  spotlightUsers: Set<string>
) {
  for (const [playerId, player] of remotePlayers) {
    const shouldSubscribe =
      spotlightUsers.has(playerId) ||                    // 스포트라이트
      isInSamePartyZone(localPosition, player.position, partyZones) || // 같은 존
      isWithinProximity(localPosition, player.position, 3.5) // 7×7 근접

    if (shouldSubscribe) {
      room.localParticipant.setTrackSubscriptionPermissions(playerId, true)
    } else {
      room.localParticipant.setTrackSubscriptionPermissions(playerId, false)
    }
  }
}
```

### 6.2 성능 최적화

- **위치 업데이트 쓰로틀링**: 100ms 간격으로 근접 계산
- **존 캐싱**: 존 정보는 공간 입장 시 로드, 변경 시 푸시
- **구독 배칭**: 여러 변경사항을 모아서 한 번에 적용

### 6.3 에지 케이스

| 상황 | 처리 |
|------|------|
| 존 경계에서 빠르게 왔다갔다 | 디바운싱 (500ms) |
| 스포트라이트 권한 있지만 존 밖 | 브로드캐스트 비활성화 |
| 파티 존과 스포트라이트 존 겹침 | 스포트라이트 우선 |

---

## 7. 관련 파일

| 파일 | 역할 |
|------|------|
| `server/socket-server.ts` | 위치 이벤트, 존 체크, 채팅 라우팅 |
| `src/features/space/livekit/` | LiveKit 트랙 구독 관리 |
| `src/features/space/socket/useSocket.ts` | 클라이언트 소켓 이벤트 |
| `prisma/schema.prisma` | PartyZone, SpotlightZone, SpotlightGrant 모델 |
| `src/app/api/spaces/[id]/zones/` | 존 CRUD API |
| `src/app/api/spaces/[id]/spotlight/` | 스포트라이트 API |

---

## 변경 이력

| 날짜 | 버전 | 변경 |
|-----|------|------|
| 2026-01-09 | 1.0.0 | 초기 설계 문서 작성 |
